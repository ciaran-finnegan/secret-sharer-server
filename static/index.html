<!DOCTYPE html>
<html>
<body onload="generatePassPhrase()">

<h1>Secret Sharing Prototype</h1>
<h2>Generate a link and token to securely share a secret</h2>
<h3>Prototype for new version with in browser encryption</h3>

<p>Links and tokens can only be used once and will epire after 72 hours.</p>
<p></p>
<p></p>
<p>
    <form action="https://w331frxwn6.execute-api.us-east-1.amazonaws.com/dev/putSecret" method="POST">
        <input type="input" name="honeypot" value="" style="display: none" tabindex="-1" autocomplete="off">
        <label>
        Secret:
        <textarea name="secret" required></textarea>
        </label>
        Expiry (hours):
        <textarea name="expiresIn" required></textarea>
        </label>
        Pass Phrase:
        <textarea name="passphrase" required></textarea>
        </label>
        <button type="submit">Create Secret Sharing Link</button>
    </form>
</p>
<b><p> Status: </p></b>
<strong><p id="createSecretStatus"></p></strong>
<b></b><p> Secret URL: </p></b>
<p id="createSecretURL"></p>
<b></b><p> Pass Phrase: </p></b>
<p id="createSecretToken"></p>


</body>
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js" integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A==" crossorigin="anonymous"></script>

<script>
    const string = 'plaintext';
    

    function generatePassPhrase() {
    // Use a more truly random password generator
        const form = document.querySelector('form');
    var length = 12,
        charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        retVal = "";
    for (var i = 0, n = charset.length; i < length; ++i) {
        retVal += charset.charAt(Math.floor(Math.random() * n));
    }
    // Initialse passphrase
    form.children.namedItem('passphrase').value = retVal;
    return retVal;
}

    const password = generatePassPhrase();
    console.log(password);


    var encrypted = CryptoJS.AES.encrypt(string, password);
    console.log(encrypted.toString());

    var decrypted = CryptoJS.AES.decrypt(encrypted, password);
    
</script>



<script>
    (() => {
  const form = document.querySelector('form');

  form.onsubmit = e => {

      
    e.preventDefault();
    // Escape if the honeypot has been filled
    if (!!form.children.namedItem('honeypot').value) return;

    // Prepare data to send
    const data = {};
    const formElements = Array.from(form);
    formElements.map(input => (data[input.name] = input.value));

    console.log(`data.secret: ${data.secret}`);
    console.log(`data.passphrase: ${data.passphrase}`);

    // Encrypt the secret sting the passphrase
    cipher = CryptoJS.AES.encrypt(data.secret, data.passphrase);
    console.log(`encrypyted secret cipher: `, cipher.toString());
    cipherString = cipher.toString();

    // Replace the secret with cipher string
    data.secret = cipherString;

    // Debug only
    const passphrase = data.passphrase;
    var decrypted = CryptoJS.AES.decrypt(data.secret, passphrase);
    console.log(`Decrypted Secret: `, decrypted.toString(CryptoJS.enc.Utf8));

    // Remove the passphrase before sending to web service
    delete data.passphrase;

    console.log(`data.secret cipher: ${data.secret}`);
    console.log (data);



    // Debug only
    var decrypted = CryptoJS.AES.decrypt(data.secret, passphrase);
    console.log(`Decrypted Secret: `, decrypted.toString(CryptoJS.enc.Utf8));

    

    // Construct an HTTP request
    var xhr = new XMLHttpRequest();
    xhr.open(form.method, form.action, true);
    xhr.setRequestHeader('Accept', 'application/json; charset=utf-8');
    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

    // Send the collected data as JSON
    xhr.send(JSON.stringify(data));

    // Callback function
    xhr.onloadend = response => {
      if (response.target.status === 200) {
        // Success
        form.reset();
        createSecretStatus.innerHTML = "Success"
        createSecretURL.innerHTML = JSON.parse(response.target.response).url
        createSecretToken.innerHTML = passphrase
      } else {
        // Failure
        createSecretStatus.innerHTML = 'Something went wrong, please try again.';
        console.error(JSON.parse(response.target.response).message);
      }
    };
  };
})();
</script>

